<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Weather Now — Dynamic Weather App</title>
    <meta
      name="description"
      content="Dynamic weather app using OpenWeatherMap API. Search by city or use geolocation. Animated icons & dynamic backgrounds based on conditions."
    />
    <style>
      :root {
        --max-width: 900px;
        --accent: #ffd166;
        --muted: #434549;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: #071022;
        color: #1d1f21;
        font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .app {
        width: 100%;
        max-width: var(--max-width);
        border-radius: 14px;
        padding: 1.25rem;
        box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6);
        backdrop-filter: blur(6px);
        overflow: hidden;
      }

      /* THEMES (body classes added dynamically) */
      .theme-clear {
        background: linear-gradient(
          180deg,
          #87ceeb 0%,
          #5cc1ff 60%,
          #0b77c2 100%
        );
      }
      .theme-clouds {
        background: linear-gradient(
          180deg,
          #9eb1c9 0%,
          #6f8aa6 60%,
          #2e4f68 100%
        );
      }
      .theme-rain {
        background: linear-gradient(
          180deg,
          #4b6b8a 0%,
          #355a7b 60%,
          #122433 100%
        );
      }
      .theme-storm {
        background: linear-gradient(
          180deg,
          #2b2f4a 0%,
          #182033 60%,
          #0b0f1a 100%
        );
      }
      .theme-snow {
        background: linear-gradient(
          180deg,
          #e6f0fb 0%,
          #cfe6fb 60%,
          #9dcff6 100%
        );
      }
      .theme-mist {
        background: linear-gradient(
          180deg,
          #7f8c8d 0%,
          #95a5a6 60%,
          #3d566e 100%
        );
      }

      /* layout */
      header {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      header h1 {
        font-size: 1.1rem;
        margin: 0;
      }
      .controls {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }
      .search {
        flex: 1;
        display: flex;
        gap: 0.5rem;
      }
      input[type="search"] {
        flex: 1;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: rgba(255, 255, 255, 0.03);
        color: inherit;
        font-size: 0.95rem;
        outline: none;
      }
      button {
        padding: 0.7rem 0.9rem;
        border-radius: 10px;
        border: none;
        background: var(--accent);
        color: #041025;
        font-weight: 600;
        cursor: pointer;
      }
      button.secondary {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: var(--muted);
      }

      .row {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }
      .card {
        flex: 1;
        padding: 1rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.02);
      }
      .main-weather {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      /* icon & animations */
      .weather-icon {
        width: 120px;
        height: 120px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .sun-rot {
        animation: spin 12s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* cloud movement */
      .clouds {
        position: relative;
        overflow: hidden;
      }
      .cloud {
        position: absolute;
        top: 10px;
        left: -20%;
        width: 200px;
        opacity: 0.9;
        filter: blur(0.2px);
        animation: cloud-move 40s linear infinite;
      }
      .cloud.two {
        top: 40px;
        left: -40%;
        width: 300px;
        animation-duration: 60s;
        opacity: 0.8;
      }
      @keyframes cloud-move {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(160%);
        }
      }

      /* raindrops */
      .rain {
        position: relative;
        overflow: hidden;
      }
      .drop {
        position: absolute;
        top: -10px;
        width: 3px;
        height: 15px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 2px;
        animation: drop 0.7s linear infinite;
      }
      .drop:nth-child(2) {
        left: 30%;
        animation-delay: 0.15s;
      }
      .drop:nth-child(3) {
        left: 60%;
        animation-delay: 0.3s;
      }
      @keyframes drop {
        0% {
          transform: translateY(-10px);
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          transform: translateY(120%);
          opacity: 0;
        }
      }

      .temp {
        font-size: 2.4rem;
        font-weight: 700;
      }
      .meta {
        color: var(--muted);
      }
      .small {
        font-size: 0.9rem;
        color: var(--muted);
      }
      .extras {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-top: 0.75rem;
      }
      .extra {
        background: rgba(255, 255, 255, 0.02);
        padding: 0.5rem;
        border-radius: 8px;
        text-align: center;
      }

      .loader {
        display: flex;
        gap: 0.6rem;
        align-items: center;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--accent);
        animation: pop 0.9s infinite;
      }
      .dot:nth-child(2) {
        animation-delay: 0.12s;
      }
      .dot:nth-child(3) {
        animation-delay: 0.24s;
      }
      @keyframes pop {
        0% {
          transform: scale(0.6);
          opacity: 0.3;
        }
        50% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: scale(0.6);
          opacity: 0.3;
        }
      }

      footer {
        margin-top: 1rem;
        text-align: center;
        color: var(--muted);
        font-size: 0.85rem;
      }
      @media (max-width: 720px) {
        .main-weather {
          flex-direction: row;
        }
        .row {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body class="theme-clear">
    <div class="app" id="app">
      <header>
        <div>
          <h1>Weather Now</h1>
          <div class="small">
            Live weather — search a city or use your location
          </div>
        </div>
        <div
          style="
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
            align-items: center;
          "
        >
          <button id="locBtn" class="secondary" title="Use my location">
            Use my location
          </button>
          <button id="unitBtn" title="Toggle °C/°F">°C</button>
        </div>
      </header>

      <div class="controls">
        <div class="search">
          <input
            id="searchInput"
            type="search"
            placeholder="Search city, e.g. Accra, London"
            aria-label="Search city"
          />
          <button id="searchBtn">Search</button>
        </div>
        <div id="message" class="small" aria-live="polite"></div>
      </div>

      <div class="row">
        <div class="card" style="flex: 2" id="mainCard">
          <div id="loading" style="display: none" class="loader">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="small">Loading...</div>
          </div>

          <div id="weatherContent" style="display: none">
            <div class="main-weather">
              <div class="weather-icon" id="iconWrap">
                <img id="iconImg" alt="weather icon" width="96" height="96" />
              </div>
              <div>
                <div class="temp" id="tempText">--°</div>
                <div class="meta" id="desc">--</div>
                <div class="small" id="locText">--</div>
              </div>
            </div>

            <div class="extras">
              <div class="extra">
                <div class="small">Humidity</div>
                <div id="humidity">--%</div>
              </div>
              <div class="extra">
                <div class="small">Wind</div>
                <div id="wind">-- m/s</div>
              </div>
              <div class="extra">
                <div class="small">Pressure</div>
                <div id="pressure">-- hPa</div>
              </div>
            </div>
          </div>

          <div
            id="error"
            style="display: none; color: #ffb4b4; margin-top: 1rem"
          ></div>
        </div>

        <div class="card" style="flex: 1">
          <div style="font-weight: 700">Details</div>
          <div id="details" class="small" style="margin-top: 0.6rem">
            Search a city or use location to see details.
          </div>
        </div>
      </div>

      <footer>
        <div>Powered by OpenWeatherMap • Key embedded for convenience</div>
      </footer>
    </div>

    <script>
      // Wait for DOM to be ready to avoid null element errors
      window.addEventListener("DOMContentLoaded", () => {
        const API_KEY = "2aa8c573141ab0838785f05515f7e069"; // your key

        // Helper to safely get element
        const $ = (id) => document.getElementById(id) || null;

        // Elements
        const searchInput = $("searchInput");
        const searchBtn = $("searchBtn");
        const locBtn = $("locBtn");
        const unitBtn = $("unitBtn");
        const message = $("message");

        const loadingEl = $("loading");
        const weatherContent = $("weatherContent");
        const errorEl = $("error");

        const tempText = $("tempText");
        const desc = $("desc");
        const locText = $("locText");
        const iconImg = $("iconImg");
        const humidity = $("humidity");
        const wind = $("wind");
        const pressure = $("pressure");
        const details = $("details");

        // Ensure `unit` is defined before we use it
        let unit = localStorage.getItem("weather_unit") || "metric"; // metric = °C, imperial = °F
        if (unitBtn) unitBtn.textContent = unit === "metric" ? "°C" : "°F";

        function showMessage(text, timeout = 3000) {
          if (message) {
            message.textContent = text;
            if (timeout)
              setTimeout(() => {
                if (message.textContent === text) message.textContent = "";
              }, timeout);
          } else {
            console.log("MSG:", text);
          }
        }

        function setLoading(on) {
          if (loadingEl) loadingEl.style.display = on ? "flex" : "none";
          if (weatherContent)
            weatherContent.style.display = on
              ? "none"
              : weatherContent.dataset.ready === "true"
              ? "block"
              : "none";
          if (errorEl) errorEl.style.display = "none";
        }

        function showError(text) {
          if (errorEl) {
            errorEl.style.display = "block";
            errorEl.textContent = text;
          } else {
            console.error("ERROR:", text);
          }
          if (loadingEl) loadingEl.style.display = "none";
        }

        function capitalize(s) {
          return s ? s.charAt(0).toUpperCase() + s.slice(1) : s;
        }

        // Theme helpers
        function clearOverlays() {
          document.querySelectorAll(".overlay").forEach((o) => o.remove());
        }

        function applyWeatherTheme(main) {
          const body = document.body;
          body.classList.remove(
            "theme-clear",
            "theme-clouds",
            "theme-rain",
            "theme-storm",
            "theme-snow",
            "theme-mist"
          );
          clearOverlays();
          const m = (main || "").toLowerCase();
          if (m.includes("cloud")) {
            body.classList.add("theme-clouds");
            addClouds();
          } else if (m.includes("rain") || m.includes("drizzle")) {
            body.classList.add("theme-rain");
            addRain();
          } else if (m.includes("thunder")) {
            body.classList.add("theme-storm");
            addRain(true);
          } else if (m.includes("snow")) {
            body.classList.add("theme-snow");
            addSnow();
          } else if (m.includes("mist") || m.includes("fog")) {
            body.classList.add("theme-mist");
          } else {
            body.classList.add("theme-clear");
            addSunLoop();
          }
        }

        function addClouds() {
          const wrap = document.createElement("div");
          wrap.className = "overlay clouds";
          const createCloud = () => {
            const img = document.createElement("img");
            img.src =
              'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="80"><g fill="white" opacity="0.9"><ellipse cx="80" cy="40" rx="60" ry="32"/><ellipse cx="140" cy="40" rx="80" ry="40"/></g></svg>';
            img.className = "cloud";
            return img;
          };
          const c1 = createCloud();
          const c2 = createCloud();
          c2.className = "cloud two";
          wrap.appendChild(c1);
          wrap.appendChild(c2);
          document.body.appendChild(wrap);
        }

        function addRain() {
          const wrap = document.createElement("div");
          wrap.className = "overlay rain";
          for (let i = 0; i < 12; i++) {
            const d = document.createElement("div");
            d.className = "drop";
            d.style.left = i * 8 + "%";
            d.style.animationDelay = i * 0.08 + "s";
            d.style.height = 10 + Math.random() * 20 + "px";
            wrap.appendChild(d);
          }
          document.body.appendChild(wrap);
        }

        function addSnow() {
          const wrap = document.createElement("div");
          wrap.className = "overlay snow";
          for (let i = 0; i < 12; i++) {
            const s = document.createElement("div");
            s.className = "drop";
            s.style.left = i * 8 + "%";
            s.style.width = "6px";
            s.style.height = "6px";
            s.style.background = "rgba(255,255,255,0.9)";
            s.style.borderRadius = "50%";
            s.style.animationDuration = 1.8 + Math.random() * 1.2 + "s";
            wrap.appendChild(s);
          }
          document.body.appendChild(wrap);
        }

        function addSunLoop() {
          const wrap = document.createElement("div");
          wrap.className = "overlay sun";
          const s = document.createElement("div");
          s.style.position = "absolute";
          s.style.right = "8%";
          s.style.top = "8%";
          s.style.opacity = "0.95";
          s.innerHTML =
            '<svg class="sun-rot" width="72" height="72" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4" fill="#FFD166"/><g stroke="#FFD166" stroke-width="1.2"><path d="M12 1v3"/><path d="M12 20v3"/><path d="M4.2 4.2l2.1 2.1"/><path d="M17.7 17.7l2.1 2.1"/><path d="M1 12h3"/><path d="M20 12h3"/><path d="M4.2 19.8l2.1-2.1"/><path d="M17.7 6.3l2.1-2.1"/></g></svg>';
          wrap.appendChild(s);
          document.body.appendChild(wrap);
        }

        // Fetch helpers
        async function fetchWeatherByCity(city) {
          if (!API_KEY) {
            showMessage("Missing API key.");
            return;
          }
          setLoading(true);
          if (errorEl) errorEl.style.display = "none";
          try {
            const q = encodeURIComponent(city);
            const url = `https://api.openweathermap.org/data/2.5/weather?q=${q}&units=${unit}&appid=${API_KEY}`;
            const res = await fetch(url);
            if (!res.ok) {
              if (res.status === 404) throw new Error("City not found.");
              else throw new Error("Weather API error: " + res.status);
            }
            const data = await res.json();
            renderWeather(data);
            try {
              localStorage.setItem("weather_last_city", city);
            } catch (e) {}
          } catch (err) {
            showError(err.message || "Unknown error");
          } finally {
            setLoading(false);
          }
        }

        async function fetchWeatherByCoords(lat, lon) {
          if (!API_KEY) {
            showMessage("Missing API key.");
            return;
          }
          setLoading(true);
          try {
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${unit}&appid=${API_KEY}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error("Weather API error: " + res.status);
            const data = await res.json();
            renderWeather(data);
            try {
              if (data && data.name)
                localStorage.setItem("weather_last_city", data.name);
            } catch (e) {}
          } catch (err) {
            showError(err.message || "Unknown error");
          } finally {
            setLoading(false);
          }
        }

        function renderWeather(data) {
          if (!data) {
            showError("No data to display.");
            return;
          }
          if (weatherContent) {
            weatherContent.style.display = "block";
            weatherContent.dataset.ready = "true";
          }

          const t = Math.round(data.main.temp);
          if (tempText) tempText.textContent = `${t}°`;
          if (desc) desc.textContent = capitalize(data.weather[0].description);
          if (locText)
            locText.textContent = `${data.name}, ${data.sys.country}`;
          if (humidity) humidity.textContent = `${data.main.humidity}%`;
          if (wind)
            wind.textContent = `${data.wind.speed} ${
              unit === "metric" ? "m/s" : "mph"
            }`;
          if (pressure) pressure.textContent = `${data.main.pressure} hPa`;
          if (details)
            details.textContent = `Feels like ${Math.round(
              data.main.feels_like
            )}°, visibility ${data.visibility}m, sunrise ${timeFromUnix(
              data.sys.sunrise,
              data.timezone
            )}, sunset ${timeFromUnix(data.sys.sunset, data.timezone)}.`;

          // icon
          const iconCode = data.weather[0].icon;
          if (iconImg) {
            iconImg.src = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
            iconImg.alt = data.weather[0].description;
          }

          // Apply theme
          applyWeatherTheme(data.weather[0].main);
        }

        function timeFromUnix(ts, tzOffset) {
          try {
            const d = new Date((ts + tzOffset) * 1000);
            const m = d.toUTCString().match(/[0-9]{2}:[0-9]{2}:[0-9]{2}/);
            return m ? m[0] : "--:--";
          } catch (e) {
            return "--:--";
          }
        }

        // UI bindings (only add listeners if elements exist)
        if (searchBtn) {
          searchBtn.addEventListener("click", () => {
            const q =
              searchInput && searchInput.value ? searchInput.value.trim() : "";
            if (!q) {
              showMessage("Type a city name.");
              return;
            }
            fetchWeatherByCity(q);
          });
        }
        if (searchInput) {
          searchInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              if (searchBtn) searchBtn.click();
            }
          });
        }

        if (locBtn) {
          locBtn.addEventListener("click", () => {
            if (!navigator.geolocation) {
              showMessage("Geolocation not supported in this browser.");
              return;
            }
            setLoading(true);
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                fetchWeatherByCoords(pos.coords.latitude, pos.coords.longitude);
              },
              (err) => {
                setLoading(false);
                showError("Geolocation permission denied or failed.");
              },
              { timeout: 10000 }
            );
          });
        }

        if (unitBtn) {
          unitBtn.addEventListener("click", () => {
            unit = unit === "metric" ? "imperial" : "metric";
            unitBtn.textContent = unit === "metric" ? "°C" : "°F";
            try {
              localStorage.setItem("weather_unit", unit);
            } catch (e) {}
            const last = (function () {
              try {
                return localStorage.getItem("weather_last_city");
              } catch (e) {
                return null;
              }
            })();
            if (last) fetchWeatherByCity(last);
            else if (navigator.geolocation)
              fetchWeatherByCoords &&
                navigator.geolocation.getCurrentPosition(
                  (pos) =>
                    fetchWeatherByCoords(
                      pos.coords.latitude,
                      pos.coords.longitude
                    ),
                  () => {},
                  { timeout: 8000 }
                );
          });
        }

        // On load: try cached city or geolocation
        (async function init() {
          const last = (function () {
            try {
              return localStorage.getItem("weather_last_city");
            } catch (e) {
              return null;
            }
          })();
          if (last) {
            if (searchInput) searchInput.value = last;
            await fetchWeatherByCity(last);
          } else {
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                (pos) => {
                  fetchWeatherByCoords(
                    pos.coords.latitude,
                    pos.coords.longitude
                  );
                },
                () => {
                  /* silent fail */
                },
                { timeout: 8000 }
              );
            }
          }
        })();

        // offline message
        window.addEventListener("offline", () =>
          showMessage(
            "You are offline — showing cached data if available",
            5000
          )
        );
      });
    </script>
  </body>
</html>
